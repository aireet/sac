syntax = "proto3";
package sac.v1;
option go_package = "g.echo.tech/dev/sac/gen/sac/v1;sacv1";

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "sac/v1/common.proto";

message WorkspaceFile {
  int64 id = 1;
  int64 user_id = 2;
  int64 agent_id = 3;
  optional int64 group_id = 4;
  string workspace_type = 5;
  string oss_key = 6;
  string file_name = 7;
  string file_path = 8;
  string content_type = 9;
  int64 size_bytes = 10;
  string checksum = 11;
  bool is_directory = 12;
  google.protobuf.Timestamp created_at = 13;
  google.protobuf.Timestamp updated_at = 14;
}

message WorkspaceStatusResponse {
  bool configured = 1;
}

message CreateShareRequest {
  int64 agent_id = 1;
  string path = 2;
}

message ShareResponse {
  string short_code = 1;
  string url = 2;
}

message SharedFileMeta {
  string file_name = 1;
  string content_type = 2;
  int64 size_bytes = 3;
}

message InternalOutputDeleteRequest {
  int64 user_id = 1;
  int64 agent_id = 2;
  string path = 3;
}

message ListOutputFilesRequest {
  int64 agent_id = 1;
  string path = 2;
}

message DeleteOutputFileRequest {
  int64 agent_id = 1;
  string path = 2;
}

message DeleteShareRequest {
  string code = 1;
}

message GetSharedFileRequest {
  string code = 1;
}

service WorkspaceService {
  // Status
  rpc GetStatus(Empty) returns (WorkspaceStatusResponse) {
    option (google.api.http) = { get: "/api/workspace/status" };
  }

  // Output workspace
  rpc ListOutputFiles(ListOutputFilesRequest) returns (FileListResponse) {
    option (google.api.http) = { get: "/api/workspace/output/files" };
  }
  rpc DeleteOutputFile(DeleteOutputFileRequest) returns (SuccessMessage) {
    option (google.api.http) = { delete: "/api/workspace/output/files" };
  }

  // Output sharing
  rpc CreateShare(CreateShareRequest) returns (ShareResponse) {
    option (google.api.http) = { post: "/api/workspace/output/share", body: "*" };
  }
  rpc DeleteShare(DeleteShareRequest) returns (SuccessMessage) {
    option (google.api.http) = { delete: "/api/workspace/output/share/{code}" };
  }

  // Shared file (public, no auth)
  rpc GetSharedFileMeta(GetSharedFileRequest) returns (SharedFileMeta) {
    option (google.api.http) = { get: "/api/s/{code}" };
  }

  // Internal (sidecar, no auth)
  rpc InternalOutputDelete(InternalOutputDeleteRequest) returns (SuccessMessage) {
    option (google.api.http) = { post: "/api/internal/output/delete", body: "*" };
  }
}
